# ******************#
# Managed by Puppet #
# ***************** #

NameVirtualHost *:<%= @port %>

<VirtualHost *:<%= @port %>>
    <% if ssl == true %>
        SSLEngine on
        SSLCertificateFile /etc/ssl/certs/<%= srvname %>.pem
        SSLCertificateKeyFile /etc/ssl/certs/<%= srvname %>.key
    <% end %>
    ServerName <%= srvname %>
    <% if serveradmin %>
        ServerAdmin <%= serveradmin %>
    <% end %>
    <% if serveraliases.is_a? Array -%>
        <% serveraliases.each do |name| -%><%= "  ServerAlias #{name}\n" %><% end -%>
    <% elsif serveraliases != '' -%>
        <%= "  ServerAlias #{serveraliases}" %>
    <% end -%>
    DocumentRoot <%= docroot %>
    <Directory <%= docroot %>>
        Options <%= options %>
        AllowOverride <%= Array(override).join(' ') %>
        Order allow,deny
        allow from all
    </Directory>
    
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F] 
    
    ErrorLog <%= logroot %>/<%= name %>_error.log
    LogLevel warn
    LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" elb
    LogFormat "%{True-Client-IP}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" akamai
    SetEnvIf True-Client-IP "^.*\..*\..*\..*" fromakamai
    CustomLog <%= logroot %>/<%= name %>_access.log elb env=!fromakamai
    CustomLog <%= logroot %>/<%= name %>_access.log akamai env=fromakamai
    ServerSignature Off
</VirtualHost>

<VirtualHost *:80>
    ServerName <%= srvname %>
    ServerAdmin <%= serveradmin %>
    RedirectMatch ^(.*)$ https://<%= srvname %>$1
</VirtualHost>
